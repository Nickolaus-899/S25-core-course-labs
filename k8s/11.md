# Secrets management


## Creting secret with `kubectl` (opaque)
We can create some test secret 
```
kubectl create secret generic test-secret --from-literal=password=12345
```

After that, we can verify that the secret was created

![secret verification](./readme_images/secret/opaque.png)

The password `12345` was successfully stored and then decoded

## Creating secrets with `Helm`

I've created `secrets.yaml` in the templates. After that, I 
generated a key with the use of `gpg`:
```
gpg --gen-key
```

To view keys we can use
```
gpg --list-keys
```

After encrypting a secret, we can see the output:
![view decoded secrets](./readme_images/secret/view_decode.png)

File `secrets.enc.yaml` I saved in k8s directory under the name `secrets.yaml`

#### Now, we can run application

```
helm secrets install python-app ./python-app -n default -f secrets.yaml
```

![helm install](./readme_images/secret/helm_secrets.png)
![verify](./readme_images/secret/get_po.png)


# Vault

Firstly, I followed the guide to install Vault and set the secret

![get pods](./readme_images/vault/start.png)

### We can set a secret 

```
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="vault" password="secret"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-05T07:43:05.440191674Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-05T07:43:05.440191674Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    secret
username    vault
/ $ exit
```

### Authentication

```
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```

### Creating service account
![service accounts](./readme_images/vault/service_account.png)

After that, I created `patch-inject.yaml` and patched it with the command:

```
kubectl patch deployment python-app --patch-file=python-app/patch-inject.yaml
```

![verify](./readme_images/vault/verification.png)

Secret was injected successfully

# Resources
